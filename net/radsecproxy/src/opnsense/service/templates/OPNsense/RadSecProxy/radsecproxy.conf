{% if helpers.exists('OPNsense.radsecproxy.general') and OPNsense.radsecproxy.general.Enabled|default("0") == "1" %}
{% set certDir = '/usr/local/etc/radsecproxy.d/certs/' %}
###########################################
# GENERAL
###########################################

PidFile 
+LogLevel 
LogFullUsername 
LogMAC 
LoopPrevention 


###########################################
# TLS-CONFIGS
###########################################

{% for tlsConfig in helpers.toList('OPNsense.radsecproxy.tlsConfigs.tlsConfig') %}
# config for TLS-Config "{{ tlsConfig.description }}"
tls {{ tlsConfig.name }} {
{% if tlsConfig.caCertificateRefId is defined and tlsConfig.caCertificateRefId != "" %}
  CACertificateFile   {{ certDir}}{{ tlsConfig.name }}_ca-cert.pem
{% endif %}
{% if tlsConfig.proxyCertificateRefId is defined and tlsConfig.proxyCertificateRefId != "" %}
  CertificateFile     {{ certDir}}{{ tlsConfig.name }}_proxy-cert.pem
  CertificateKeyFile  {{ certDir}}{{ tlsConfig.name }}_proxy-key.pem
{% endif %}
{% if tlsConfig.policyOids is defined and tlsConfig.policyOids != "" %}
{% for policyOid in tlsConfig.policyOids.split(',') %}
  PolicyOID {{ policyOid }}
{% endfor %}
{% endif %}
  CRLCheck {{ tlsConfig.crlCheck }}
{% if tlsConfig.cacheExpiry is defined and tlsConfig.cacheExpiry != "" %}
  CacheExpiry {{ tlsConfig.cacheExpiry }}
{% endif %}
}

{% endfor %}

###########################################
# CLIENTS
###########################################

{% for client in helpers.toList('OPNsense.radsecproxy.clients.client') %}
{% if client.enabled is defined and client.enabled == "1" %}
# config for client "{{ client.description }}"
client {{ client['@uuid'] }} {
  Host {{ client.host }}
  Type {{ client.type }}
{% if client.secret is defined and client.secret != "" %}
  Secret {{ client.secret }}
{% endif %}
{% if client.tlsConfig is defined and client.tlsConfig != "" %}
{% set tlsConfig = helpers.getUUID(client.tlsConfig) %}
  Tls {{ tlsConfig.name }}
{% endif %}
  CertificateNameCheck {{ client.certificateNameCheck }}
{% if client.matchCertificateAttribute is defined and client.matchCertificateAttribute != "" %}
  matchCertificateAttribute {{ client.matchCertificateAttribute }}
{% endif %}
{% if client.customConfig is defined and client.customConfig != "" %}
  {{ client.customConfig }}
{% endif %}
}

{% else %}
# config for client "{{ client.description }}" not enabled, skipping!"

{% endif %}
{% endfor %}

###########################################
# SERVERS
###########################################

{% for server in helpers.toList('OPNsense.radsecproxy.servers.server') %}
# config for server "{{ server.description }}"
server {{ server['@uuid'] }} {
  Host {{ server.host }}
{% if server.port is defined and server.port != "" %}
  Port {{ server.port }}
{% endif %}
  Type {{ server.type }}
{% if server.secret is defined and server.secret != "" %}
  Secret {{ server.secret }}
{% endif %}
{% if server.tlsConfig is defined and server.tlsConfig != "" %}
{% set tlsConfig = helpers.getUUID(server.tlsConfig) %}
  Tls {{ tlsConfig.name }}
{% endif %}
  StatusServer {{ server.statusServer }}
  CertificateNameCheck {{ server.certificateNameCheck }}
{% if server.matchCertificateAttribute is defined and server.matchCertificateAttribute != "" %}
  matchCertificateAttribute {{ server.matchCertificateAttribute }}
{% endif %}
{% if server.customConfig is defined and server.customConfig != "" %}
  {{ server.customConfig }}
{% endif %}
}

{% endfor %}

###########################################
# REALMS
###########################################

{% for realm in helpers.toList('OPNsense.radsecproxy.realms.realm') %}
{% if realm.enabled is defined and realm.enabled == "1" %}
# config for realm "{{ realm.realm }}"
realm {{ realm.realm }} {
{% if realm.server is defined and realm.server != "" %}
{% for serverUuid in realm.server.split(',') %}
{% set server = helpers.getUUID(serverUuid) %}
  Server {{ serverUuid }} # Server "{{ server.description }}"
{% endfor %}
{% endif %}
{% if realm.replyMessage is defined and realm.replyMessage != "" %}
  ReplyMessage {{ realm.replyMessage }}
{% endif %}
{% if realm.accountingResponse is defined and realm.accountingResponse != "" %}
  AccountingResponse {{ realm.accountingResponse }}
{% endif %}
}

{% else %}
# config for realm "{{ realm.realm }}" not enabled, skipping!"

{% endif %}
{% endfor %}
{# END OF TEMPLATE #}
{% endif %}
