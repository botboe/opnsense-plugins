{% if helpers.exists('OPNsense.radsecproxy.general') and OPNsense.radsecproxy.general.Enabled|default("0") == "1" %}
{% set certDir = '/usr/local/etc/radsecproxy.d/certs/' %}

[general]
SMTPHost={{ OPNsense.radsecproxy.general.Enabled|default("") }}

{{ OPNsense.radsecproxy.tlsConfigs }}
{{ OPNsense.radsecproxy.clients }}

{% for tlsConfig in helpers.toList('OPNsense.radsecproxy.tlsConfigs.tlsConfig') %}

# config for {{ tlsConfig }}
tls {{ tlsConfig.name }} {
    CACertificateFile   {{ certDir}}{{ tlsConfig.name }}_ca-cert.pem
    CertificateFile     {{ certDir}}{{ tlsConfig.name }}_proxy-cert.pem
    CertificateKeyFile  {{ certDir}}{{ tlsConfig.name }}_proxy-key.pem
}

{% endfor %}

{% for client in helpers.toList('OPNsense.radsecproxy.clients.client') %}
# config for {{ client }}
# config for client "{{ client.description }}"
client {{ client.host }} {
  Type {{ client.type }}
{% if client.secret|default("") != "" %}
  Secret {{ client.secret }}
{% endif %}
{% if client.customConfig|default("") != "" %}
  {{ client.customConfig }}
{% endif %}
}
{% endfor %}

###########################################
# SERVERS
###########################################

{% for server in helpers.toList('OPNsense.radsecproxy.servers.server') %}
# config for {{ server }}
# config for server "{{ server.description }}"
server {{ server['@uuid'] }} {
  Host {{ server.host }}
{% if server.port is defined and server.port != "" %}
  Port {{ server.port }}
{% endif %}
  Type {{ server.type }}
{% if server.secret is defined and server.secret != "" %}
  Secret {{ server.secret }}
{% endif %}
{% if server.tlsConfig is defined and server.tlsConfig != "" %}
{% set tlsConfig = helpers.getUUID(server.tlsConfig) %}
  Tls {{ tlsConfig.name }}
{% endif %}
  StatusServer {{ server.statusServer }}
  CertificateNameCheck {{ server.certificateNameCheck }}
{% if server.customConfig is defined and server.customConfig != "" %}
  {{ server.customConfig }}
{% endif %}
{% if server.matchCertificateAttribute is defined and server.matchCertificateAttribute != "" %}
  matchCertificateAttribute {{ server.matchCertificateAttribute }}
{% endif %}
}
{% endfor %}

###########################################
# REALMS
###########################################

{% for realm in helpers.toList('OPNsense.radsecproxy.realms.realm') %}
# config for realm "{{ realm }}"
# config for realm "{{ realm.realm }}"
realm {{ realm.realm }} {
{% if realm.server is defined and realm.server != "" %}
{% for serverUuid in realm.server.split(',') %}
{% set server = helpers.getUUID(serverUuid) %}
  Server {{ serverUuid }} # Server "{{ server.description }}"
{% endfor %}
{% endif %}
{% if realm.replyMessage is defined and realm.replyMessage != "" %}
  ReplyMessage {{ realm.replyMessage }}
{% endif %}
{% if realm.accountingResponse is defined and realm.accountingResponse != "" %}
  AccountingResponse {{ realm.accountingResponse }}
{% endif %}
}
{% endfor %}
{# END OF TEMPLATE #}
{% endif %}